# handlers/faction.py

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

from modules.faction import factions
from utils.format import section_header

async def handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = str(update.effective_user.id)
    args = context.args

    if not args:
        kb = []
        for faction_id, faction in factions.items():
            kb.append([InlineKeyboardButton(
                f"Join {faction.name}",
                callback_data=f"join_{faction_id}"
            )])

        kb.append([InlineKeyboardButton("Close", callback_data="close")])

        player_faction = "None"
        for faction_id, faction in factions.items():
            if uid in faction.members:
                player_faction = faction.name
                break

        await update.message.reply_text(
            f"{section_header('FACTIONS', '🌐')}\n\n"
            f"Your Current Faction: {player_faction}\n\n"
            "Available Factions:\n\n" +
            "\n".join([f"{faction_id.capitalize()}: {faction.description}" for faction_id, faction in factions.items()]),
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup(kb)
        )
        return

    action = args[0].lower()
    if action == "join" and len(args) > 1:
        faction_id = args[1].lower()
        if faction_id in factions:
            # Check if player is already in a faction
            for existing_faction in factions.values():
                if uid in existing_faction.members:
                    await update.message.reply_text(
                        "You are already part of a faction. Leave your current faction first.",
                        parse_mode="Markdown"
                    )
                    return

            # Add player to the selected faction
            factions[faction_id].add_member(uid)
            await update.message.reply_text(
                f"✅ *You have joined the {factions[faction_id].name} faction!* ✅\n\n"
                f"Faction Bonus: +{factions[faction_id].bonus_value}x {factions[faction_id].bonus_type} production!",
                parse_mode="Markdown"
            )
        else:
            await update.message.reply_text(
                "Faction not found. Use /faction to see available factions.",
                parse_mode="Markdown"
            )