# handlers/black_market.py

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, CallbackQueryHandler

from modules.black_market import BlackMarketItem
from utils.format import section_header

black_market_items = [
    BlackMarketItem("Battle Reviver", "Revives all lost units in battle (one-time use)", 150, "revive"),
    BlackMarketItem("Elite Soldier Package", "Unlocks elite unit training", 300, "elite_units"),
    BlackMarketItem("Advanced Technology", "Provides a permanent 20% resource production boost", 250, "tech_boost"),
]

async def handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = str(update.effective_user.id)
    args = context.args

    if not args:
        kb = [[InlineKeyboardButton(f"Buy {item.name} ({item.cost} SkyBucks)", callback_data=f"buy_{i}")] for i, item in enumerate(black_market_items)]
        kb.append([InlineKeyboardButton("Close", callback_data="close")])

        player_data = load_player_data(uid)

        await update.message.reply_text(
            f"{section_header('BLACK MARKET', 'ðŸ’Ž')}\n\n"
            f"SkyBucks: {player_data['skybucks']}ðŸ’Ž\n\n"
            "Special items available for SkyBucks:\n\n" +
            "\n".join([f"{i+1}. {item.name}: {item.cost}ðŸ’Ž - {item.description}" for i, item in enumerate(black_market_items)]),
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup(kb)
        )
        return

    item_id = args[0]
    if item_id.isdigit() and 0 <= int(item_id) < len(black_market_items):
        item = black_market_items[int(item_id)]
        player_data = load_player_data(uid)

        if player_data["skybucks"] >= item.cost:
            # Deduct SkyBucks
            player_data["skybucks"] -= item.cost
            save_player_data(uid, player_data)

            # Apply item effect
            if item.effect == "revive":
                item.apply_effect(uid)
                await update.message.reply_text(
                    f"ðŸ’Ž *Item Purchased!* ðŸ’Ž\n\n"
                    f"You've bought {item.name}!\n"
                    f"All lost units have been revived!",
                    parse_mode="Markdown"
                )
            else:
                await update.message.reply_text(
                    f"ðŸ’Ž *Item Purchased!* ðŸ’Ž\n\n"
                    f"You've bought {item.name}!\n"
                    f"Effect: {item.description}",
                    parse_mode="Markdown"
                )
        else:
            await update.message.reply_text(
                "Insufficient SkyBucks. Use /daily to earn more or visit the black market!",
                parse_mode="Markdown"
            )
    else:
        await update.message.reply_text(
            "Invalid item ID. Use /blackmarket to see available items.",
            parse_mode="Markdown"
        )